<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns      #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell   #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TupleSections     #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications  #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns      #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-comment">-- | Float bindings inwards.</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusIR.Transform.LetFloatIn</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#floatTerm"><span class="hs-identifier">floatTerm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.html"><span class="hs-identifier">PlutusCore</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.html"><span class="hs-identifier">PlutusIR</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html"><span class="hs-identifier">PlutusIR.Analysis.Usages</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Usages</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html"><span class="hs-identifier">PlutusIR.Purity</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusIR.Transform.Rename.html"><span class="hs-identifier">PlutusIR.Transform.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../extra/html/src"><span class="hs-identifier">Control.Monad.Extra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../extra/html/src"><span class="hs-identifier">ifM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier">Control.Monad.Trans.Reader</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier">foldrM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../extra/html/src"><span class="hs-identifier">Data.List.Extra</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../extra/html/src"><span class="hs-identifier">Data.List.NonEmpty.Extra</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../extra/html/src"><span class="hs-identifier">Data.List.NonEmpty.Extra</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-comment">{- Note [Float-in]

-------------------------------------------------------------------------------
1. Which bindings can be floated in?
-------------------------------------------------------------------------------

Strict bindings whose RHSs are impure should never be moved, since they can change the
semantics of the program. We can only move non-strict bindings or strict bindings
whose RHSs are pure.

We also need to be very careful about moving a strict binding whose RHS is not a work-free
(though pure). Consider a strict binding whose RHS is a pure, expensive application. If we
move it into, e.g., a lambda, its RHS may end up being evaluated more times. Although this
doesn't change the semantics of the program, it can make it much more expensive. For
simplicity, we do not move such bindings either.

In the rest of this Note, we may simply use &quot;binding&quot; to refer to either a non-strict
binding, or a strict binding whose RHS is work-free. Usually there's no need to distinguish
between these two, since `let x (nonstrict) = rhs` is essentially equivalent to
`let x (strict) = all a rhs`.

-------------------------------------------------------------------------------
2. The effect of floating in
-------------------------------------------------------------------------------

If we only float in bindings that are either non-strict, or whose RHSs is a work-free, then
why does that make a difference? Because such bindings are not completely free: when we
move a non-strict binding `let x (nonstrict) = rhs`, what we are really moving around is
`delay rhs`, lambda abstractions and lambda applications. None of them is free because
they incur CEK machine costs.

Here's a concrete example where floating a non-strict binding inwards saves cost:

let a (nonstrict) = rhs in if True then t else ..a..

Without floating `a` into the `else` branch, it is compiled into (in pseudo-UPLC)

[(\a -&gt; if True then t else ..a..) (delay rhs)]

If we float `a` into the `else` branch, then it is compiled into

if True then t else [(\a -&gt; ..a..) rhs]

Since the `else` branch is not taken, the former incurs additional `LamAbs`, `Apply`
and `Delay` steps when evaluated by the CEK machine. Note that `rhs` itself is
evaluated the same number of times (i.e., zero time) in both cases.

And floating a binding inwards can also increases cost. Here's an example:

let a (nonstrict) = rhs in let b (nonstrict) = a in b+b

Because `b` is non-strict and occurs twice in the body, floating the definition of `a` into
the RHS of `b` will incur one more of each of these steps: `Delay`, `LamAbs` and `Apply`.

-------------------------------------------------------------------------------
3. When can floating-in increase costs?
-------------------------------------------------------------------------------

Floating-in a binding can increase cost only if the binding is originally outside of `X`,
and is floated into `X`, and `X` satisfies both of the following conditions:

(1) `X` is a lambda abstraction, a type abstraction, or the RHS of a non-strict binding
(recall that the RHS of a non-strict binding is equivalent to a type abstraction).

(2) `X` is in the RHS of a (either strict or non-strict) binding whose LHS is used more than once.

Note the &quot;only if&quot; - the above are the necessary conditions, but not sufficient. Also note
that this is in the context of the float-in pass itself. Floating a binding in /can/ affect
ther subsequent optimizations in a negative way (e.g., inlining).

-------------------------------------------------------------------------------
4. Implementation of the float-in pass
-------------------------------------------------------------------------------

This float-in pass is a conservative optimization which tries to avoid increasing costs.
The implementation recurses into the top-level `Term` using the following context type:

data FloatInContext = FloatInContext
    { _ctxtInManyOccRhs :: Bool
    , _ctxtUsages       :: Usages.Usages
    }

`ctxtUsages` is the usage counts of variables, and `ctxtInManyOccRhs` is initially `False`.
`ctxtInManyOccRhs` is set to `True` if we descend into:

(1) The RHS of a binding whose LHS is used more than once
(2) The argument of an application, unless the function is a LamAbs whose bound variable
is used at most once, or a Builtin.

The value of `ctxtInManyOccRhs` is used as follows:

(1) When `ctxtInManyOccRhs = False`, we avoid descending into the RHS of a non-strict binding
whose LHS is used more than once, and we descend in all other cases;
(2) When `ctxtInManyOccRhs = True`, we additionally avoid descending into `LamAbs` or `TyAbs`.

-}</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | The uniques of all used variables in a term.</span><span>
</span><span id="line-128"></span><span class="hs-keyword">type</span><span> </span><span id="Uniques"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-var">Uniques</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-keyword">data</span><span> </span><span id="FloatInContext"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#FloatInContext"><span class="hs-identifier hs-var">FloatInContext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FloatInContext"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#FloatInContext"><span class="hs-identifier hs-var">FloatInContext</span></a></span></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_ctxtInManyOccRhs"><span class="annot"><span class="annottext">FloatInContext -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#_ctxtInManyOccRhs"><span class="hs-identifier hs-var hs-var">_ctxtInManyOccRhs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- ^ Whether we are in the RHS of a binding whose LHS is used more than once.</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-comment">-- See Note [Float-in] #4</span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_ctxtUsages"><span class="annot"><span class="annottext">FloatInContext -&gt; Usages
</span><a href="PlutusIR.Transform.LetFloatIn.html#_ctxtUsages"><span class="hs-identifier hs-var hs-var">_ctxtUsages</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="ctxtUsages"><span id="ctxtInManyOccRhs"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FloatInContext</span></span></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- | Float bindings in the given `Term` inwards.</span><span>
</span><span id="line-140"></span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#floatTerm"><span class="hs-identifier hs-type">floatTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681152268"><span class="annot"><a href="#local-6989586621681152268"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621681152273"><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681152276"><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681152271"><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681152270"><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681152265"><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TypeUnique"><span class="hs-identifier hs-type">PLC.TypeUnique</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">PLC.MonadQuote</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152268"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><a href="#local-6989586621681152268"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span id="floatTerm"><span class="annot"><span class="annottext">floatTerm :: forall (m :: * -&gt; *) tyname name (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, HasUnique tyname TypeUnique,
 ToBuiltinMeaning uni fun, MonadQuote m) =&gt;
BuiltinVersion fun
-&gt; Term tyname name uni fun a -&gt; m (Term tyname name uni fun a)
</span><a href="PlutusIR.Transform.LetFloatIn.html#floatTerm"><span class="hs-identifier hs-var hs-var">floatTerm</span></a></span></span><span> </span><span id="local-6989586621681151967"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151967"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621681151966"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151966"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621681151965"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151965"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). (Rename a, MonadQuote m) =&gt; a -&gt; m a
</span><a href="PlutusCore.Rename.html#rename"><span class="hs-identifier hs-var">PLC.rename</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151966"><span class="hs-identifier hs-var">t0</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151962"><span class="hs-identifier hs-var">floatTermInner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name tyname (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, HasUnique tyname TypeUnique) =&gt;
Term tyname name uni fun a -&gt; Usages
</span><a href="PlutusIR.Analysis.Usages.html#termUsages"><span class="hs-identifier hs-var">Usages.termUsages</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151965"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151965"><span class="hs-identifier hs-var">t1</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><a href="#local-6989586621681151962"><span class="hs-identifier hs-type">floatTermInner</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="PlutusIR.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621681151962"><span class="annot"><span class="annottext">floatTermInner :: Usages
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151962"><span class="hs-identifier hs-var hs-var">floatTermInner</span></a></span></span><span> </span><span id="local-6989586621681151960"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681151960"><span class="hs-identifier hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-comment">-- Float bindings in the given `Term` inwards, and annotate each term with the set of</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">-- used term `Unique`s in the `Term`.</span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><a href="#local-6989586621681151959"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>        </span><span id="local-6989586621681151959"><span class="annot"><span class="annottext">go :: Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681151958"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151958"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151958"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-166"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621681151956"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151956"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151955"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151955"><span class="hs-identifier hs-var">fun0</span></a></span></span><span> </span><span id="local-6989586621681151954"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151954"><span class="hs-identifier hs-var">arg0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151953"><span class="annot"><span class="annottext">fun :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151953"><span class="hs-identifier hs-var hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151955"><span class="hs-identifier hs-var">fun0</span></a></span><span>
</span><span id="line-168"></span><span>                    </span><span id="local-6989586621681151952"><span class="annot"><span class="annottext">arg :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151952"><span class="hs-identifier hs-var hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151954"><span class="hs-identifier hs-var">arg0</span></a></span><span>
</span><span id="line-169"></span><span>                    </span><span id="local-6989586621681151950"><span class="annot"><span class="annottext">us :: Uniques
</span><a href="#local-6989586621681151950"><span class="hs-identifier hs-var hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151953"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.union`</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151952"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-170"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151956"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151950"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151953"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151952"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span id="local-6989586621681151946"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151946"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151945"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151945"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681151944"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151944"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681151943"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151943"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151942"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151942"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151943"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-173"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151946"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151942"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151945"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151944"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151942"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span id="local-6989586621681151939"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151939"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151938"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681151938"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681151937"><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621681151937"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681151936"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151936"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151935"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151935"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151936"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-176"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151939"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151935"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681151938"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Kind a
</span><a href="#local-6989586621681151937"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151935"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-177"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span> </span><span id="local-6989586621681151933"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151933"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151932"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151932"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span id="local-6989586621681151931"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151931"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151930"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151930"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151932"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-179"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151933"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151930"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151930"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151931"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span> </span><span id="local-6989586621681151928"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151928"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151927"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151927"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681151926"><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151926"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681151925"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151925"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151924"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151924"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151925"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-182"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Type tyname uni a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151928"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151924"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151927"><span class="hs-identifier hs-var">ty1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><a href="#local-6989586621681151926"><span class="hs-identifier hs-var">ty2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151924"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-183"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span> </span><span id="local-6989586621681151922"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151922"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151921"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151921"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-184"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151920"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151920"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151921"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-185"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151922"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151920"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151920"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-186"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681151918"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151918"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span id="local-6989586621681151916"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681151916"><span class="hs-identifier hs-var">bs0</span></a></span></span><span> </span><span id="local-6989586621681151915"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151915"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151912"><span class="annot"><span class="annottext">bs :: NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151912"><span class="hs-identifier hs-var hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151911"><span class="hs-identifier hs-var">goBinding</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681151916"><span class="hs-identifier hs-var">bs0</span></a></span><span>
</span><span id="line-188"></span><span>                    </span><span id="local-6989586621681151909"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151909"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151915"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-189"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- The bindings in `bs` should be processed from right to left, since</span><span>
</span><span id="line-190"></span><span>                    </span><span class="hs-comment">-- a binding may depend on another binding to its left.</span><span>
</span><span id="line-191"></span><span>                    </span><span class="hs-comment">-- e.g. let x = 1; y = x in ... y ...</span><span>
</span><span id="line-192"></span><span>                    </span><span class="hs-comment">-- we want to float y in first otherwise it will block us from floating in x</span><span>
</span><span id="line-193"></span><span>                    </span><span class="annot"><span class="annottext">forall r a. Reader r a -&gt; r -&gt; a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runReader</span></a></span><span>
</span><span id="line-194"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; b -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
BuiltinVersion fun
-&gt; a
-&gt; Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="PlutusIR.Transform.LetFloatIn.html#floatInBinding"><span class="hs-identifier hs-var">floatInBinding</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151967"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151918"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151909"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151912"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Usages -&gt; FloatInContext
</span><a href="PlutusIR.Transform.LetFloatIn.html#FloatInContext"><span class="hs-identifier hs-var">FloatInContext</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681151960"><span class="hs-identifier hs-var">usgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621681151906"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151906"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span id="local-6989586621681151904"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681151904"><span class="hs-identifier hs-var">bs0</span></a></span></span><span> </span><span id="local-6989586621681151903"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151903"><span class="hs-identifier hs-var">body0</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>                </span><span class="hs-comment">-- Currently we don't move recursive bindings, so we simply descend into the body.</span><span>
</span><span id="line-198"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151901"><span class="annot"><span class="annottext">bs :: NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151901"><span class="hs-identifier hs-var hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
-&gt; Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151911"><span class="hs-identifier hs-var">goBinding</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun a)
</span><a href="#local-6989586621681151904"><span class="hs-identifier hs-var">bs0</span></a></span><span>
</span><span id="line-199"></span><span>                    </span><span id="local-6989586621681151900"><span class="annot"><span class="annottext">body :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151900"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151903"><span class="hs-identifier hs-var">body0</span></a></span><span>
</span><span id="line-200"></span><span>                    </span><span id="local-6989586621681151896"><span class="annot"><span class="annottext">us :: Uniques
</span><a href="#local-6989586621681151896"><span class="hs-identifier hs-var hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151900"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-var">bindingUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151901"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151906"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151896"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151901"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151900"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-202"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621681151892"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151892"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151891"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151891"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a -&gt; name -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151892"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151891"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151891"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-203"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151958"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151958"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151958"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-comment">-- Float bindings in the given `Binding` inwards, and calculate the set of</span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-comment">-- variable `Unique`s in the result `Binding`.</span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><a href="#local-6989586621681151911"><span class="hs-identifier hs-type">goBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-210"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-211"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152273"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152270"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152265"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>        </span><span id="local-6989586621681151911"><span class="annot"><span class="annottext">goBinding :: Binding tyname name uni fun a
-&gt; Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151911"><span class="hs-identifier hs-var hs-var">goBinding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span id="local-6989586621681151883"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151883"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681151882"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151882"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621681151881"><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><a href="#local-6989586621681151881"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681151880"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151880"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151879"><span class="annot"><span class="annottext">rhs' :: Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151879"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151959"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151880"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-215"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Strictness
-&gt; VarDecl tyname name uni a
-&gt; Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151883"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151879"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151882"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><a href="#local-6989586621681151881"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151879"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-216"></span><span>            </span><span id="local-6989586621681151878"><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681151878"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var">noUniq</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun a
</span><a href="#local-6989586621681151878"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span id="local-6989586621681152201"><span id="local-6989586621681152202"><span id="local-6989586621681152203"><span id="local-6989586621681152204"><span id="local-6989586621681152205"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-type">termUniqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152205"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152204"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152203"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152202"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152201"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span></span></span></span></span></span><span>
</span><span id="line-219"></span><span id="termUniqs"><span class="annot"><span class="annottext">termUniqs :: forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var hs-var">termUniqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a -&gt; a
</span><a href="PlutusIR.Core.Type.html#termAnn"><span class="hs-identifier hs-var">termAnn</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="hs-comment">-- | Returns the set of `Unique`s in the RHS of a `Binding`.</span><span>
</span><span id="line-222"></span><span id="local-6989586621681152169"><span id="local-6989586621681152170"><span id="local-6989586621681152171"><span id="local-6989586621681152172"><span id="local-6989586621681152173"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-type">bindingUniqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152173"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152172"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152171"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152170"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152169"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span></span></span></span></span></span><span>
</span><span id="line-223"></span><span id="bindingUniqs"><span class="annot"><span class="annottext">bindingUniqs :: forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-var hs-var">bindingUniqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun a -&gt; a
</span><a href="PlutusIR.Core.Type.html#bindingAnn"><span class="hs-identifier hs-var">bindingAnn</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span id="local-6989586621681152193"><span id="local-6989586621681152194"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-type">noUniq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152194"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681152194"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152193"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681152194"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152193"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-226"></span><span id="noUniq"><span class="annot"><span class="annottext">noUniq :: forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f (a, Uniques)
</span><a href="PlutusIR.Transform.LetFloatIn.html#noUniq"><span class="hs-identifier hs-var hs-var">noUniq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-comment">-- See Note [Float-in] #1</span><span>
</span><span id="line-229"></span><span id="local-6989586621681152128"><span id="local-6989586621681152129"><span id="local-6989586621681152130"><span id="local-6989586621681152131"><span id="local-6989586621681152132"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#floatable"><span class="hs-identifier hs-type">floatable</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152132"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152131"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152131"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152130"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152129"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152132"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152131"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152128"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-234"></span><span id="floatable"><span class="annot"><span class="annottext">floatable :: forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun -&gt; Binding tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#floatable"><span class="hs-identifier hs-var hs-var">floatable</span></a></span></span><span> </span><span id="local-6989586621681151868"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151868"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span id="local-6989586621681151867"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151867"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span> </span><span id="local-6989586621681151865"><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><a href="#local-6989586621681151865"><span class="hs-identifier hs-var">_var</span></a></span></span><span> </span><span id="local-6989586621681151864"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151864"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun -&gt; Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#isEssentiallyWorkFree"><span class="hs-identifier hs-var">isEssentiallyWorkFree</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151868"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151864"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span id="local-6989586621681151862"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151862"><span class="hs-identifier hs-var">_a</span></a></span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span id="local-6989586621681151860"><span class="annot"><span class="annottext">VarDecl tyname name uni a
</span><a href="#local-6989586621681151860"><span class="hs-identifier hs-var">_var</span></a></span></span><span> </span><span id="local-6989586621681151859"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151859"><span class="hs-identifier hs-var">_rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">-- We currently don't move type and datatype bindings.</span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#DatatypeBind"><span class="hs-identifier hs-type">DatatypeBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">{- | Whether evaluating a given `Term` is essentially work-free (barring the CEK machine overhead).

 See Note [Float-in] #1
-}</span><span>
</span><span id="line-245"></span><span id="local-6989586621681152118"><span id="local-6989586621681152119"><span id="local-6989586621681152120"><span id="local-6989586621681152121"><span id="local-6989586621681152122"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#isEssentiallyWorkFree"><span class="hs-identifier hs-type">isEssentiallyWorkFree</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152122"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152121"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152121"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152120"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152119"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152122"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152121"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152118"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span></span><span>
</span><span id="line-247"></span><span id="isEssentiallyWorkFree"><span class="annot"><span class="annottext">isEssentiallyWorkFree :: forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun -&gt; Term tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#isEssentiallyWorkFree"><span class="hs-identifier hs-var hs-var">isEssentiallyWorkFree</span></a></span></span><span> </span><span id="local-6989586621681151855"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151855"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {tyname} {name} {a}. Term tyname name uni fun a -&gt; Bool
</span><a href="#local-6989586621681151854"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621681151854"><span class="annot"><span class="annottext">go :: Term tyname name uni fun a -&gt; Bool
</span><a href="#local-6989586621681151854"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-253"></span><span>        </span><span id="local-6989586621681151850"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151850"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681151849"><span class="annot"><span class="annottext">bapp :: BuiltinApp tyname name uni fun a
</span><a href="#local-6989586621681151849"><span class="hs-identifier hs-var">bapp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Purity.html#BuiltinApp"><span class="hs-identifier hs-type">BuiltinApp</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681151847"><span class="annot"><span class="annottext">[Arg tyname name uni fun a]
</span><a href="#local-6989586621681151847"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun a
-&gt; Maybe (BuiltinApp tyname name uni fun a)
</span><a href="PlutusIR.Purity.html#asBuiltinApp"><span class="hs-identifier hs-var">asBuiltinApp</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151850"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>                </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun
-&gt; BuiltinApp tyname name uni fun a -&gt; Maybe Bool
</span><a href="PlutusIR.Purity.html#isSaturated"><span class="hs-identifier hs-var">isSaturated</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151855"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinApp tyname name uni fun a
</span><a href="#local-6989586621681151849"><span class="hs-identifier hs-var">bapp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html#TermArg"><span class="hs-identifier hs-type">TermArg</span></a></span><span> </span><span id="local-6989586621681151839"><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151839"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a -&gt; Bool
</span><a href="#local-6989586621681151854"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><a href="#local-6989586621681151839"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><a href="PlutusIR.Purity.html#TypeArg"><span class="hs-identifier hs-type">TypeArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Arg tyname name uni fun a]
</span><a href="#local-6989586621681151847"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-257"></span><span>        </span><span class="annot"><span class="annottext">Term tyname name uni fun a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">{- | Given a `Term` and a `Binding`, determine whether the `Binding` can be
 placed somewhere inside the `Term`.

 If yes, return the result `Term`. Otherwise, return a `Let` constructed from
 the given `Binding` and `Term`.
-}</span><span>
</span><span id="line-265"></span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#floatInBinding"><span class="hs-identifier hs-type">floatInBinding</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681152177"><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span></span><span> </span><span id="local-6989586621681152181"><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681152180"><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681152179"><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681152178"><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">PLC.HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">PLC.BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-comment">-- | Annotation to be attached to the constructed `Let`.</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">Reader</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#FloatInContext"><span class="hs-identifier hs-type">FloatInContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span id="floatInBinding"><span class="annot"><span class="annottext">floatInBinding :: forall tyname name (uni :: * -&gt; *) fun a.
(HasUnique name TermUnique, ToBuiltinMeaning uni fun) =&gt;
BuiltinVersion fun
-&gt; a
-&gt; Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="PlutusIR.Transform.LetFloatIn.html#floatInBinding"><span class="hs-identifier hs-var hs-var">floatInBinding</span></a></span></span><span> </span><span id="local-6989586621681151772"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151772"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621681151771"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151771"><span class="hs-identifier hs-var">letAnn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681151770"><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151770"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun tyname name a.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun -&gt; Binding tyname name uni fun a -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#floatable"><span class="hs-identifier hs-var">floatable</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621681151772"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151770"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151770"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681151768"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151768"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151766"><span class="annot"><span class="annottext">us :: Uniques
</span><a href="#local-6989586621681151766"><span class="hs-identifier hs-var hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151768"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-var">bindingUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151770"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151771"><span class="hs-identifier hs-var">letAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151766"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151770"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151768"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-283"></span><span>    </span><span class="annot"><a href="#local-6989586621681151769"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-284"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">Reader</span></a></span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#FloatInContext"><span class="hs-identifier hs-type">FloatInContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152177"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152181"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152180"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152179"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152178"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621681151769"><span class="annot"><span class="annottext">go :: Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681151765"><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681151764"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151764"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151763"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151762"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151762"><span class="hs-identifier hs-var">_s</span></a></span></span><span> </span><span id="local-6989586621681151761"><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621681151760"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151760"><span class="hs-identifier hs-var">_rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151764"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151759"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151759"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151758"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151758"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151757"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151757"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681151756"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151756"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-290"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151757"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>                    </span><span class="hs-comment">-- `fun` does not mention `var`, so we can place the binding inside `arg`.</span><span>
</span><span id="line-292"></span><span>                    </span><span class="hs-comment">-- See Note [Float-in] #3</span><span>
</span><span id="line-293"></span><span>                    </span><span id="local-6989586621681151754"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681151754"><span class="hs-identifier hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r a. Monad m =&gt; (r -&gt; a) -&gt; ReaderT r m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInContext -&gt; Usages
</span><a href="PlutusIR.Transform.LetFloatIn.html#_ctxtUsages"><span class="hs-identifier hs-var">_ctxtUsages</span></a></span><span>
</span><span id="line-294"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151747"><span class="annot"><span class="annottext">inManyOccRhs :: Bool
</span><a href="#local-6989586621681151747"><span class="hs-identifier hs-var hs-var">inManyOccRhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151757"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-295"></span><span>                            </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">(a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681151746"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151746"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>                                </span><span class="annot"><span class="annottext">forall n unique. HasUnique n unique =&gt; n -&gt; Usages -&gt; Int
</span><a href="PlutusIR.Analysis.Usages.html#getUsageCount"><span class="hs-identifier hs-var">Usages.getUsageCount</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151746"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681151754"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-297"></span><span>                            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-298"></span><span>                            </span><span class="hs-comment">-- We need to be conservative here, this could be something</span><span>
</span><span id="line-299"></span><span>                            </span><span class="hs-comment">-- that computes to a function that uses its argument repeatedly.</span><span>
</span><span id="line-300"></span><span>                            </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-301"></span><span>                    </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151759"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151758"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151757"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-302"></span><span>                        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a.
(r -&gt; r) -&gt; ReaderT r m a -&gt; ReaderT r m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">local</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">Lens' FloatInContext Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#ctxtInManyOccRhs"><span class="hs-identifier hs-var">ctxtInManyOccRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681151747"><span class="hs-identifier hs-var">inManyOccRhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151756"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151756"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>                    </span><span class="hs-comment">-- `arg` does not mention `var`, so we can place the binding inside `fun`.</span><span>
</span><span id="line-305"></span><span>                    </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151759"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151758"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151757"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151756"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-306"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151740"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151740"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151739"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151739"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151738"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151738"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681151737"><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151737"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681151736"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151736"><span class="hs-identifier hs-var">lamAbsBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>                </span><span class="hs-comment">-- We float into lambdas only if `_ctxtInManyOccRhs = False`.</span><span>
</span><span id="line-308"></span><span>                </span><span class="hs-comment">-- See Note [Float-in] #3</span><span>
</span><span id="line-309"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; m a -&gt; m a -&gt; m a
</span><a href="../../../../extra/html/src"><span class="hs-identifier hs-var">ifM</span></a></span><span>
</span><span id="line-310"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r a. Monad m =&gt; (r -&gt; a) -&gt; ReaderT r m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInContext -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#_ctxtInManyOccRhs"><span class="hs-identifier hs-var">_ctxtInManyOccRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>                    </span><span class="annot"><span class="annottext">Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var">giveup</span></a></span><span>
</span><span id="line-312"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; name
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151740"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151739"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681151738"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151737"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151736"><span class="hs-identifier hs-var">lamAbsBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-type">TyAbs</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151734"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151734"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151733"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151733"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151732"><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681151732"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681151731"><span class="annot"><span class="annottext">Kind (a, Uniques)
</span><a href="#local-6989586621681151731"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681151730"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151730"><span class="hs-identifier hs-var">tyAbsBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>                </span><span class="hs-comment">-- We float into type abstractions only if `_ctxtInManyOccRhs = False`.</span><span>
</span><span id="line-315"></span><span>                </span><span class="hs-comment">-- See Note [Float-in] #3</span><span>
</span><span id="line-316"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; m a -&gt; m a -&gt; m a
</span><a href="../../../../extra/html/src"><span class="hs-identifier hs-var">ifM</span></a></span><span>
</span><span id="line-317"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r a. Monad m =&gt; (r -&gt; a) -&gt; ReaderT r m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">FloatInContext -&gt; Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#_ctxtInManyOccRhs"><span class="hs-identifier hs-var">_ctxtInManyOccRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>                    </span><span class="annot"><span class="annottext">Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var">giveup</span></a></span><span>
</span><span id="line-319"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; tyname
-&gt; Kind a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyAbs"><span class="hs-identifier hs-var">TyAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151734"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151733"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">tyname
</span><a href="#local-6989586621681151732"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Kind (a, Uniques)
</span><a href="#local-6989586621681151731"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151730"><span class="hs-identifier hs-var">tyAbsBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-type">TyInst</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151729"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151729"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151728"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151728"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151727"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151727"><span class="hs-identifier hs-var">tyInstBody</span></a></span></span><span> </span><span id="local-6989586621681151726"><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151726"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>                </span><span class="hs-comment">-- A term binding can always be placed inside the body a `TyInst` because the</span><span>
</span><span id="line-322"></span><span>                </span><span class="hs-comment">-- type cannot mention the bound variable</span><span>
</span><span id="line-323"></span><span>                </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Term tyname name uni fun a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TyInst"><span class="hs-identifier hs-var">TyInst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151729"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151728"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151727"><span class="hs-identifier hs-var">tyInstBody</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151726"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151725"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151725"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151724"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151724"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span id="local-6989586621681151723"><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151723"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681151722"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151722"><span class="hs-identifier hs-var">letBody</span></a></span></span><span>
</span><span id="line-325"></span><span>                </span><span class="hs-comment">-- The binding can be placed inside a `Let`, if the right hand sides of the</span><span>
</span><span id="line-326"></span><span>                </span><span class="hs-comment">-- bindings of the `Let` do not mention `var`.</span><span>
</span><span id="line-327"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-var">bindingUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151723"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>                    </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151725"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151724"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151723"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151722"><span class="hs-identifier hs-var">letBody</span></a></span><span>
</span><span id="line-329"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151722"><span class="hs-identifier hs-var">letBody</span></a></span><span>
</span><span id="line-330"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151721"><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151721"><span class="hs-identifier hs-var">before</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151720"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151720"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151719"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151719"><span class="hs-identifier hs-var">usBind'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151718"><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151718"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621681151717"><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151717"><span class="hs-identifier hs-var">var'</span></a></span></span><span> </span><span id="local-6989586621681151716"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151716"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151715"><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151715"><span class="hs-identifier hs-var">after</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-331"></span><span>                    </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
TermUnique
-&gt; [Binding tyname name uni fun (a, Uniques)]
-&gt; Maybe
     ([Binding tyname name uni fun (a, Uniques)],
      Binding tyname name uni fun (a, Uniques),
      [Binding tyname name uni fun (a, Uniques)])
</span><a href="PlutusIR.Transform.LetFloatIn.html#splitBindings"><span class="hs-identifier hs-var">splitBindings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151761"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a unique. HasUnique a unique =&gt; Lens' a unique
</span><a href="PlutusCore.Name.html#unique"><span class="hs-identifier hs-var">PLC.unique</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. NonEmpty a -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">NonEmpty.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151723"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>                    </span><span class="hs-comment">-- `letBody` does not mention `var`, and there is exactly one</span><span>
</span><span id="line-333"></span><span>                    </span><span class="hs-comment">-- RHS in `bs` that mentions `var`, so we can place `b`</span><span>
</span><span id="line-334"></span><span>                    </span><span class="hs-comment">-- inside one of the RHSs in `bs`.</span><span>
</span><span id="line-335"></span><span>                    </span><span id="local-6989586621681151712"><span class="annot"><span class="annottext">FloatInContext
</span><a href="#local-6989586621681151712"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) r. Monad m =&gt; ReaderT r m r
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-336"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151707"><span class="annot"><span class="annottext">usageCnt :: Int
</span><a href="#local-6989586621681151707"><span class="hs-identifier hs-var hs-var">usageCnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n unique. HasUnique n unique =&gt; n -&gt; Usages -&gt; Int
</span><a href="PlutusIR.Analysis.Usages.html#getUsageCount"><span class="hs-identifier hs-var">Usages.getUsageCount</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151717"><span class="hs-identifier hs-var">var'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatInContext
</span><a href="#local-6989586621681151712"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Lens' FloatInContext Usages
</span><a href="PlutusIR.Transform.LetFloatIn.html#ctxtUsages"><span class="hs-identifier hs-var">ctxtUsages</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>                        </span><span id="local-6989586621681151703"><span class="annot"><span class="annottext">safe :: Bool
</span><a href="#local-6989586621681151703"><span class="hs-keyword hs-var hs-var">safe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151718"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-338"></span><span>                            </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#Strict"><span class="hs-identifier hs-var">Strict</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-339"></span><span>                            </span><span class="annot"><span class="annottext">Strictness
</span><a href="PlutusIR.Core.Type.html#NonStrict"><span class="hs-identifier hs-var">NonStrict</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-340"></span><span>                                </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatInContext
</span><a href="#local-6989586621681151712"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Lens' FloatInContext Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#ctxtInManyOccRhs"><span class="hs-identifier hs-var">ctxtInManyOccRhs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                                    </span><span class="hs-comment">-- Descending into a non-strict binding whose LHS is used</span><span>
</span><span id="line-342"></span><span>                                    </span><span class="hs-comment">-- more than once should be avoided, regardless of</span><span>
</span><span id="line-343"></span><span>                                    </span><span class="hs-comment">-- `ctxtInManyOccRhs`.</span><span>
</span><span id="line-344"></span><span>                                    </span><span class="hs-comment">-- See Note [Float-in] #3</span><span>
</span><span id="line-345"></span><span>                                    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151707"><span class="hs-identifier hs-var">usageCnt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-346"></span><span>                        </span><span id="local-6989586621681151699"><span class="annot"><span class="annottext">inManyOccRhs :: Bool
</span><a href="#local-6989586621681151699"><span class="hs-identifier hs-var hs-var">inManyOccRhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151707"><span class="hs-identifier hs-var">usageCnt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-347"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681151703"><span class="hs-keyword hs-var">safe</span></a></span><span>
</span><span id="line-348"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>                            </span><span id="local-6989586621681151698"><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151698"><span class="hs-identifier hs-var">b''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-350"></span><span>                                </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Strictness
-&gt; VarDecl tyname name uni a
-&gt; Term tyname name uni fun a
-&gt; Binding tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-var">TermBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151720"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151719"><span class="hs-identifier hs-var">usBind'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Strictness
</span><a href="#local-6989586621681151718"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><a href="#local-6989586621681151717"><span class="hs-identifier hs-var">var'</span></a></span><span>
</span><span id="line-351"></span><span>                                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a.
(r -&gt; r) -&gt; ReaderT r m a -&gt; ReaderT r m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">local</span></a></span><span>
</span><span id="line-352"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">Lens' FloatInContext Bool
</span><a href="PlutusIR.Transform.LetFloatIn.html#ctxtInManyOccRhs"><span class="hs-identifier hs-var">ctxtInManyOccRhs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681151699"><span class="hs-identifier hs-var">inManyOccRhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151716"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151697"><span class="annot"><span class="annottext">bs' :: NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151697"><span class="hs-identifier hs-var hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="../../../../extra/html/src"><span class="hs-identifier hs-var">NonEmpty.appendr</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151721"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151698"><span class="hs-identifier hs-var">b''</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">:|</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151715"><span class="hs-identifier hs-var">after</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>                            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151725"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151724"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Binding tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151697"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151722"><span class="hs-identifier hs-var">letBody</span></a></span><span>
</span><span id="line-356"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var">giveup</span></a></span><span>
</span><span id="line-357"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-type">IWrap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151695"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151695"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151694"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151694"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151693"><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151693"><span class="hs-identifier hs-var">ty1</span></a></span></span><span> </span><span id="local-6989586621681151692"><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151692"><span class="hs-identifier hs-var">ty2</span></a></span></span><span> </span><span id="local-6989586621681151691"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151691"><span class="hs-identifier hs-var">iwrapBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>                </span><span class="hs-comment">-- A binding can always be placed inside an `IWrap`.</span><span>
</span><span id="line-359"></span><span>                </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Type tyname uni a
-&gt; Type tyname uni a
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#IWrap"><span class="hs-identifier hs-var">IWrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151695"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151694"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151693"><span class="hs-identifier hs-var">ty1</span></a></span><span> </span><span class="annot"><span class="annottext">Type tyname uni (a, Uniques)
</span><a href="#local-6989586621681151692"><span class="hs-identifier hs-var">ty2</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151691"><span class="hs-identifier hs-var">iwrapBody</span></a></span><span>
</span><span id="line-360"></span><span>            </span><span class="annot"><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-type">Unwrap</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681151690"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151690"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151689"><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151689"><span class="hs-identifier hs-var">usBody</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681151688"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151688"><span class="hs-identifier hs-var">unwrapBody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-361"></span><span>                </span><span class="hs-comment">-- A binding can always be placed inside an `Unwrap`.</span><span>
</span><span id="line-362"></span><span>                </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a -&gt; Term tyname name uni fun a -&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Unwrap"><span class="hs-identifier hs-var">Unwrap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151690"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151763"><span class="hs-identifier hs-var">usBind</span></a></span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151689"><span class="hs-identifier hs-var">usBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
-&gt; Term tyname name uni fun (a, Uniques)
-&gt; Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151769"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151688"><span class="hs-identifier hs-var">unwrapBody</span></a></span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var">giveup</span></a></span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-comment">-- TODO: implement float-in for type and datatype bindings.</span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var">giveup</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>        </span><span id="local-6989586621681151735"><span class="annot"><span class="annottext">giveup :: Reader FloatInContext (Term tyname name uni fun (a, Uniques))
</span><a href="#local-6989586621681151735"><span class="hs-identifier hs-var hs-var">giveup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681151684"><span class="annot"><span class="annottext">us :: Uniques
</span><a href="#local-6989586621681151684"><span class="hs-identifier hs-var hs-var">us</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Set.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151764"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Binding tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#bindingUniqs"><span class="hs-identifier hs-var">bindingUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
a
-&gt; Recursivity
-&gt; NonEmpty (Binding tyname name uni fun a)
-&gt; Term tyname name uni fun a
-&gt; Term tyname name uni fun a
</span><a href="PlutusIR.Core.Type.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681151771"><span class="hs-identifier hs-var">letAnn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uniques
</span><a href="#local-6989586621681151684"><span class="hs-identifier hs-var">us</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Recursivity
</span><a href="PlutusIR.Core.Type.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Binding tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151765"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151764"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">{- | Split the given list of bindings, if possible.
 If the input contains exactly one binding @b@ that mentions the given `PLC.TermUnique`,
 return @Just (before_b, b, after_b)@.
 Otherwise, return `Nothing`.
-}</span><span>
</span><span id="line-376"></span><span id="local-6989586621681152060"><span id="local-6989586621681152061"><span id="local-6989586621681152062"><span id="local-6989586621681152063"><span id="local-6989586621681152064"><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#splitBindings"><span class="hs-identifier hs-type">splitBindings</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">PLC.TermUnique</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-special">[</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152064"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152063"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152062"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152061"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152060"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152064"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152063"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152062"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152061"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152060"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152064"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152063"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152062"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152061"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152060"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PlutusIR.Core.Type.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152064"><span class="hs-identifier hs-type">tyname</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152063"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152062"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681152061"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681152060"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusIR.Transform.LetFloatIn.html#Uniques"><span class="hs-identifier hs-type">Uniques</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-384"></span><span id="splitBindings"><span class="annot"><span class="annottext">splitBindings :: forall tyname name (uni :: * -&gt; *) fun a.
TermUnique
-&gt; [Binding tyname name uni fun (a, Uniques)]
-&gt; Maybe
     ([Binding tyname name uni fun (a, Uniques)],
      Binding tyname name uni fun (a, Uniques),
      [Binding tyname name uni fun (a, Uniques)])
</span><a href="PlutusIR.Transform.LetFloatIn.html#splitBindings"><span class="hs-identifier hs-var hs-var">splitBindings</span></a></span></span><span> </span><span id="local-6989586621681151681"><span class="annot"><span class="annottext">TermUnique
</span><a href="#local-6989586621681151681"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621681151680"><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151680"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(Binding tyname name uni fun (a, Uniques), Int)]
</span><a href="#local-6989586621681151679"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681151678"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151678"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151678"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151680"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151680"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; Int -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">!!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151678"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">drop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681151678"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151680"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>    </span><span class="annot"><span class="annottext">[(Binding tyname name uni fun (a, Uniques), Int)]
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-388"></span><span>    </span><span id="local-6989586621681151679"><span class="annot"><span class="annottext">is :: [(Binding tyname name uni fun (a, Uniques), Int)]
</span><a href="#local-6989586621681151679"><span class="hs-identifier hs-var hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-identifier hs-var">List.filter</span></a></span><span> </span><span class="annot"><span class="annottext">forall {tyname} {name} {uni :: * -&gt; *} {fun} {a} {b}.
(Binding tyname name uni fun (a, Uniques), b) -&gt; Bool
</span><a href="#local-6989586621681151670"><span class="hs-identifier hs-var">containsUniq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Binding tyname name uni fun (a, Uniques)]
</span><a href="#local-6989586621681151680"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../../../../ghc/html/libraries/base-4.16.3.0/src"><span class="hs-operator hs-var">`zip`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>    </span><span id="local-6989586621681151670"><span class="annot"><span class="annottext">containsUniq :: (Binding tyname name uni fun (a, Uniques), b) -&gt; Bool
</span><a href="#local-6989586621681151670"><span class="hs-identifier hs-var hs-var">containsUniq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="PlutusIR.Core.Type.html#TermBind"><span class="hs-identifier hs-type">TermBind</span></a></span><span> </span><span class="annot"><span class="annottext">(a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Strictness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">VarDecl tyname name uni (a, Uniques)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681151668"><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151668"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TermUnique
</span><a href="#local-6989586621681151681"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="../../../../containers/html/src"><span class="hs-operator hs-var">`Set.member`</span></a></span><span> </span><span class="annot"><span class="annottext">forall tyname name (uni :: * -&gt; *) fun a.
Term tyname name uni fun (a, Uniques) -&gt; Uniques
</span><a href="PlutusIR.Transform.LetFloatIn.html#termUniqs"><span class="hs-identifier hs-var">termUniqs</span></a></span><span> </span><span class="annot"><span class="annottext">Term tyname name uni fun (a, Uniques)
</span><a href="#local-6989586621681151668"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">(Binding tyname name uni fun (a, Uniques), b)
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-392"></span></pre></body></html>